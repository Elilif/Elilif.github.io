<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-02-22 Thu 19:48 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>百般武艺，此乃 Emacs （一）：用 Emacs 写博客</title>
<meta name="author" content="Eli Qian" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/css/style.css" />
                  <script src="/scripts/script.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/lisp.min.js"></script>

<script>hljs.highlightAll();</script>
</head>
<body>
<div id="preamble" class="status">
<nav class="nav">
  <a href="/index.html" class="button">Home</a>
  <a href="/rss.xml" class="button">RSS</a>
  <a href="/config.html" class="button">Literate Emacs Config</a>
</nav>
<hr>
</div>
<div id="content" class="content">
<header>
<h1 class="title">百般武艺，此乃 Emacs （一）：用 Emacs 写博客</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgc469000">1. 使用 ox-publish.el 来生成博客</a>
<ul>
<li><a href="#org886384a">1.1. 为什么选择 ox-publish.el</a></li>
<li><a href="#org2bffcbf">1.2. 博客结构</a></li>
<li><a href="#org7f7d257">1.3. 基本配置</a></li>
</ul>
</li>
<li><a href="#org07ca46b">2. RSS 生成</a></li>
<li><a href="#org0428cd8">3. Org 文学编程网页导出</a></li>
<li><a href="#orga26fcaf">4. 总结</a></li>
</ul>
</div>
</nav>
<div class="preview" id="org0542355">
本文简要介绍了如何使用 Emacs 来生成静态博客网站。主要分为三个模块：

<ol class="org-ol">
<li>博客生成</li>
<li>RSS 生成</li>
<li>文学编程网页导出</li>
</ol>

</div>

<div id="outline-container-orgc469000" class="outline-2">
<h2 id="orgc469000"><span class="section-number-2">1.</span> 使用 ox-publish.el 来生成博客</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org886384a" class="outline-3">
<h3 id="org886384a"><span class="section-number-3">1.1.</span> 为什么选择 ox-publish.el</h3>
<div class="outline-text-3" id="text-1-1">
<p>
在 Emacs 里写博客的方案有很多，比如说 Org + Hugo 、Markdown/Org + Jekyll 等等。它们各有各的优点，但这不是本文的讨论重点，有兴趣的读者可以自行查阅。我之所以使用
ox-publish.el ，主要有以下几点原因：
</p>
</div>
<ul class="org-ul">
<li><a id="org905d8a6"></a>兼容性<br>
<div class="outline-text-4" id="text-org905d8a6">
<p>
我基本上所有的写作活动都是在 Org-mode 里完成的，对 Org-mode 有着比较深度的自定义配置，因此希望能直接基于 org 文件来生成博客。Hugo 虽然号称能够解析 org 格式，但是对于自定义的格式就无能为力了。比如说<a href="https://orgmode.org/manual/Adding-Hyperlink-Types.html">自定义的链接格式</a>。而 ox-publish.el 采用的是 Org-mode 自带的导出功能，只需要你自己写好相关格式的导出方式，便可以完美地支持任何 org 文件。
</p>
</div>
</li>
<li><a id="orgbfce007"></a>内置<br>
<div class="outline-text-4" id="text-orgbfce007">
<p>
ox-publish.el 中的 <code>ox</code> 是 <code>org-export</code> 的缩写，从名字就能看出来它是 Org-mode 导出功能的一个模块。因此可以和 Org-mode 的其他功能功能无缝整合，任何需求都能较为简单地实现。内置的另一个好处是我不用担心这个项目后续的发展，只要 Org-mode 还能用，
ox-publish.el 就能用。
</p>
</div>
</li>
</ul>
</div>
<div id="outline-container-org2bffcbf" class="outline-3">
<h3 id="org2bffcbf"><span class="section-number-3">1.2.</span> 博客结构</h3>
<div class="outline-text-3" id="text-1-2">
<p>
首先介绍一下博客的基本结构
</p>

<pre class="example" id="org8b416d5">
├── articles/
├── config.html
├── css/
│   └── style.css
├── index.html
├── rss.xml
└── scripts/
    └── script.js
</pre>

<dl class="org-dl">
<dt>articles</dt><dd>此文件夹包含所有的博客文章</dd>
<dt>css</dt><dd>此文件夹包含所有的 CSS 文件</dd>
<dt>script</dt><dd>此文件夹包含所有的 JS 文件</dd>
<dt>config.html</dt><dd>我的 Emacs 文学编程配置</dd>
<dt>index.html</dt><dd>博客主页</dd>
<dt>rss.xml</dt><dd>RSS 订阅</dd>
</dl>
</div>
</div>
<div id="outline-container-org7f7d257" class="outline-3">
<h3 id="org7f7d257"><span class="section-number-3">1.3.</span> 基本配置</h3>
<div class="outline-text-3" id="text-1-3">
<p>
ox-publish.el 的配置几乎只用一个变量 <code>org-publish-project-alist</code> 就能完成，非常简单。相关语法和用法请查阅 <code>org-publish-project-alist</code> 的文档和 <a href="https://orgmode.org/manual/Publishing.html">Publishing (The Org
Manual)</a> ，本文将侧重于分享我的个人配置。
</p>

<p>
<code>org-publish-project-alist</code> 中个每个元素就是一个发布项目，其有一个项目名和一个
property list 组成。如：
</p>

<div class="multilang" id="orgafb6732">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>my-blog</div><pre class="src src-emacs-lisp" id="my-blog"><code>("eli's blog"
 &lt;&lt;misc&gt;&gt;

 &lt;&lt;sitemap&gt;&gt;

 &lt;&lt;html&gt;&gt;
 )
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>("eli's blog"
 :base-directory ,eli/blog-base-dir
 :publishing-directory ,(expand-file-name "articles" eli/blog-publish-dir)
 :base-extension "org"
 :recursive nil
 :htmlized-source t
 :publishing-function eli/org-blog-publish-to-html
 :exclude "rss.org"

 :auto-sitemap t
 :preparation-function eli/kill-sitemap-buffer
 :completion-function eli/blog-publish-completion
 :sitemap-filename ,eli/blog-sitamap
 :sitemap-title "Eli's Blog"
 :sitemap-sort-files anti-chronologically
 :sitemap-function eli/org-publish-sitemap
 :sitemap-format-entry eli/sitemap-dated-entry-format

 :html-head "&lt;link rel=\"stylesheet\" type=\"text/css\" href=\"/css/style.css\" /&gt;
  &lt;script src=\"/scripts/script.js\"&gt;&lt;/script&gt;"
 :html-preamble t
 :html-preamble-format (("en" "&lt;nav class=\"nav\"&gt;
   &lt;a href=\"/index.html\" class=\"button\"&gt;Home&lt;/a&gt;
   &lt;a href=\"/rss.xml\" class=\"button\"&gt;RSS&lt;/a&gt;
   &lt;a href=\"/config.html\" class=\"button\"&gt;Literate Emacs Config&lt;/a&gt;
 &lt;/nav&gt;
 &lt;hr&gt;"))
 :html-postamble t
 :html-postamble-format (("en" "&lt;hr class=\"Solid\"&gt;
 &lt;div class=\"info\"&gt;
   &lt;span class=\"author\"&gt;Author: %a (%e)&lt;/span&gt;
   &lt;span class=\"date\"&gt;Create Date: %d&lt;/span&gt;
   &lt;span class=\"date\"&gt;Last modified: %C&lt;/span&gt;
   &lt;span&gt;Creator: %c&lt;/span&gt;
 &lt;/div&gt;"))
 :with-creator nil
 )
</code></pre>
</div>

</div>

<p>
我们的主要工作就是配置这个 property list 以满足我们不同的需求，接下来的几个部分将介绍我们所使用的属性：
</p>
</div>

<ul class="org-ul">
<li><a id="orge85df55"></a>杂项部分<br>
<div class="outline-text-4" id="text-orge85df55">
<p>
我希望博客的导出和常规 HTML 之间的行为有所区别，所以首先让我们定义一个专门用于博客导出的 org 导出后端 <code>blog</code> ，这是为了方便修改<code>html</code> 后端的默认行为，比如说我们可以修改对 org-mode 中代码块的处理：由于我采用的是文学编程，所以希望在没有
<code>caption</code>的时候用代码块的 <code>name</code> 属性来作为代码块的标签。
</p>

<div class="multilang" id="org20b4f88">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>backend</div><pre class="src src-emacs-lisp" id="backend"><code>(org-export-define-derived-backend 'blog 'html
  :translate-alist '((src-block . eli/org-blog-src-block)))
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(org-export-define-derived-backend 'blog 'html
  :translate-alist '((src-block . eli/org-blog-src-block)))
</code></pre>
</div>

</div>

<div class="multilang" id="orgbd1a0cb">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>eli/org-blog-src-block</div><pre class="src src-emacs-lisp" id="eli/org-blog-src-block"><code>(defun eli/org-blog-src-block (src-block _contents info)
  "Transcode a SRC-BLOCK element from Org to HTML.
CONTENTS holds the contents of the item.  INFO is a plist holding
contextual information."
  (if (org-export-read-attribute :attr_html src-block :textarea)
      (org-html--textarea-block src-block)
    (let* ((lang (org-element-property :language src-block))
           (code (org-html-format-code src-block info))
           (label (let ((lbl (org-html--reference src-block info t)))
                    (if lbl (format " id=\"%s\"" lbl) "")))
           (klipsify  (and  (plist-get info :html-klipsify-src)
                            (member lang '("javascript" "js"
                                           "ruby" "scheme" "clojure" "php" "html")))))
      (if (not lang) (format "&lt;pre class=\"example\"%s&gt;\n%s&lt;/pre&gt;" label code)
        (format "&lt;div class=\"org-src-container\"&gt;\n%s%s\n&lt;/div&gt;"
                ;; Build caption.
                (let ((caption (or (org-export-get-caption src-block)
                                   (org-element-property :name src-block))))
                  (if (not caption) ""
                    (let ((listing-number
                           (format
                            "&lt;span class=\"listing-number\"&gt;%s &lt;/span&gt;"
                            "Label: ")))
                      (format "&lt;div class=\"org-src-name\"&gt;%s%s&lt;/div&gt;"
                              listing-number
                              (org-trim (org-export-data caption info))))))
                ;; Contents.
                (if klipsify
                    (format "&lt;pre&gt;&lt;code class=\"src src-%s\"%s%s&gt;%s&lt;/code&gt;&lt;/pre&gt;"
                            lang
                            label
                            (if (string= lang "html")
                                " data-editor-type=\"html\""
                              "")
                            code)
                  (format "&lt;pre class=\"src src-%s\"%s&gt;%s&lt;/pre&gt;"
                          lang label code)))))))
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(defun eli/org-blog-src-block (src-block _contents info)
  "Transcode a SRC-BLOCK element from Org to HTML.
CONTENTS holds the contents of the item.  INFO is a plist holding
contextual information."
  (if (org-export-read-attribute :attr_html src-block :textarea)
      (org-html--textarea-block src-block)
    (let* ((lang (org-element-property :language src-block))
           (code (org-html-format-code src-block info))
           (label (let ((lbl (org-html--reference src-block info t)))
                    (if lbl (format " id=\"%s\"" lbl) "")))
           (klipsify  (and  (plist-get info :html-klipsify-src)
                            (member lang '("javascript" "js"
                                           "ruby" "scheme" "clojure" "php" "html")))))
      (if (not lang) (format "&lt;pre class=\"example\"%s&gt;\n%s&lt;/pre&gt;" label code)
        (format "&lt;div class=\"org-src-container\"&gt;\n%s%s\n&lt;/div&gt;"
                ;; Build caption.
                (let ((caption (or (org-export-get-caption src-block)
                                   (org-element-property :name src-block))))
                  (if (not caption) ""
                    (let ((listing-number
                           (format
                            "&lt;span class=\"listing-number\"&gt;%s &lt;/span&gt;"
                            "Label: ")))
                      (format "&lt;div class=\"org-src-name\"&gt;%s%s&lt;/div&gt;"
                              listing-number
                              (org-trim (org-export-data caption info))))))
                ;; Contents.
                (if klipsify
                    (format "&lt;pre&gt;&lt;code class=\"src src-%s\"%s%s&gt;%s&lt;/code&gt;&lt;/pre&gt;"
                            lang
                            label
                            (if (string= lang "html")
                                " data-editor-type=\"html\""
                              "")
                            code)
                  (format "&lt;pre class=\"src src-%s\"%s&gt;%s&lt;/pre&gt;"
                          lang label code)))))))
</code></pre>
</div>

</div>

<p>
接下来我们需要为 ox-publish 定义一个导出后端为 <code>blog</code> 的发布函数：
</p>

<div class="multilang" id="orgcf3d99d">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>eli/org-blog-publish-to-html</div><pre class="src src-emacs-lisp" id="eli/org-blog-publish-to-html"><code>;;;###autoload
(defun eli/org-blog-publish-to-html (plist filename pub-dir)
  "Publish an org file to HTML.

FILENAME is the filename of the Org file to be published.  PLIST
is the property list for the given project.  PUB-DIR is the
publishing directory.

Return output file name."
  (org-publish-org-to 'blog filename
                      (concat (when (&gt; (length org-html-extension) 0) ".")
                              (or (plist-get plist :html-extension)
                                  org-html-extension
                                  "html"))
                      plist pub-dir))
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>;;;###autoload
(defun eli/org-blog-publish-to-html (plist filename pub-dir)
  "Publish an org file to HTML.

FILENAME is the filename of the Org file to be published.  PLIST
is the property list for the given project.  PUB-DIR is the
publishing directory.

Return output file name."
  (org-publish-org-to 'blog filename
                      (concat (when (&gt; (length org-html-extension) 0) ".")
                              (or (plist-get plist :html-extension)
                                  org-html-extension
                                  "html"))
                      plist pub-dir))
</code></pre>
</div>

</div>

<p>
为了方便后续的编辑，我们定义如下几个变量：
</p>

<div class="multilang" id="org723ea32">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>blog-variables</div><pre class="src src-emacs-lisp" id="blog-variables"><code>(setq eli/blog-base-dir "path-to/blog/"
      eli/blog-publish-dir "your-blog-site-dir"
      eli/blog-sitamap "index.org")
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(setq eli/blog-base-dir "path-to/blog/"
      eli/blog-publish-dir "your-blog-site-dir"
      eli/blog-sitamap "index.org")
</code></pre>
</div>

</div>

<p>
至此，property list 中的杂项部分就完成了，下面这些未指出的属性读者可以查阅
<a href="https://orgmode.org/manual/Publishing.html">Publishing (The Org Manual)</a> 等文档，这里就不一一说明了。
</p>
<div class="multilang" id="org00c31ea">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>misc</div><pre class="src src-emacs-lisp" id="misc"><code>:base-directory ,eli/blog-base-dir
:publishing-directory ,(expand-file-name "articles" eli/blog-publish-dir)
:base-extension "org"
:recursive nil
:htmlized-source t
:publishing-function eli/org-blog-publish-to-html
:exclude "rss.org"
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>:base-directory ,eli/blog-base-dir
:publishing-directory ,(expand-file-name "articles" eli/blog-publish-dir)
:base-extension "org"
:recursive nil
:htmlized-source t
:publishing-function eli/org-blog-publish-to-html
:exclude "rss.org"
</code></pre>
</div>

</div>
</div>
</li>
<li><a id="org8fc4aa5"></a>HTML 部分<br>
<div class="outline-text-4" id="text-org8fc4aa5">
<p>
org 文件导出后的 HTML 主要由 <code>preamble</code> 、<code>content</code> 和 <code>postamble</code> 三个部分组成，我们的文章内容填充的是 <code>content</code> 部分，其他两个部分由变量 <code>org-html-preamble</code> 、
<code>org-html-preamble-format</code> 、 <code>org-html-postamble</code> 和 <code>org-html-postamble-format</code> 分别控制。其具体用途可任由读者发挥，这里我们将 <code>preamle</code> 用做导航栏，而 <code>postamble</code> 则用作提供文章信息。
</p>

<p>
导航栏是几个很简单的标签（具体可以查阅变量 <code>org-html-preamble-format</code> 的文档）：
</p>
<div class="multilang" id="org95266ba">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>preamble</div><pre class="src src-emacs-lisp" id="preamble"><code>(("en" "&lt;nav class=\"nav\"&gt;
  &lt;a href=\"/index.html\" class=\"button\"&gt;Home&lt;/a&gt;
  &lt;a href=\"/rss.xml\" class=\"button\"&gt;RSS&lt;/a&gt;
  &lt;a href=\"/config.html\" class=\"button\"&gt;Literate Emacs Config&lt;/a&gt;
&lt;/nav&gt;
&lt;hr&gt;"))
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(("en" "&lt;nav class=\"nav\"&gt;
  &lt;a href=\"/index.html\" class=\"button\"&gt;Home&lt;/a&gt;
  &lt;a href=\"/rss.xml\" class=\"button\"&gt;RSS&lt;/a&gt;
  &lt;a href=\"/config.html\" class=\"button\"&gt;Literate Emacs Config&lt;/a&gt;
&lt;/nav&gt;
&lt;hr&gt;"))
</code></pre>
</div>

</div>

<p>
postamble 则提供了作者、创建时间和修改时间等信息（具体可以查阅变量
<code>org-html-postamble-format</code> 的文档）：
</p>
<div class="multilang" id="orga5fedba">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>postamble</div><pre class="src src-emacs-lisp" id="postamble"><code>(("en" "&lt;hr class=\"Solid\"&gt;
&lt;div class=\"info\"&gt;
  &lt;span class=\"author\"&gt;Author: %a (%e)&lt;/span&gt;
  &lt;span class=\"date\"&gt;Create Date: %d&lt;/span&gt;
  &lt;span class=\"date\"&gt;Last modified: %C&lt;/span&gt;
  &lt;span&gt;Creator: %c&lt;/span&gt;
&lt;/div&gt;"))
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(("en" "&lt;hr class=\"Solid\"&gt;
&lt;div class=\"info\"&gt;
  &lt;span class=\"author\"&gt;Author: %a (%e)&lt;/span&gt;
  &lt;span class=\"date\"&gt;Create Date: %d&lt;/span&gt;
  &lt;span class=\"date\"&gt;Last modified: %C&lt;/span&gt;
  &lt;span&gt;Creator: %c&lt;/span&gt;
&lt;/div&gt;"))
</code></pre>
</div>

</div>

<p>
此外，我们还可以为导出的 HTML 提供 CSS 和 JS 文件，以获取更舒适的浏览体验（具体可以查阅变量 <code>org-html-head</code> 的文档）：
</p>
<div class="multilang" id="org6c7a301">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>head</div><pre class="src src-emacs-lisp" id="head"><code>"&lt;link rel=\"stylesheet\" type=\"text/css\" href=\"/css/style.css\" /&gt;
 &lt;script src=\"/scripts/script.js\"&gt;&lt;/script&gt;"
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>"&lt;link rel=\"stylesheet\" type=\"text/css\" href=\"/css/style.css\" /&gt;
 &lt;script src=\"/scripts/script.js\"&gt;&lt;/script&gt;"
</code></pre>
</div>

</div>

<p>
至此，property list 中的 HTML 部分就大致完成了：
</p>

<div class="multilang" id="org4eeca76">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>html</div><pre class="src src-emacs-lisp" id="html"><code>:html-head &lt;&lt;head&gt;&gt;
:html-preamble t
:html-preamble-format &lt;&lt;preamble&gt;&gt;
:html-postamble t
:html-postamble-format &lt;&lt;postamble&gt;&gt;
:with-creator nil
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>:html-head "&lt;link rel=\"stylesheet\" type=\"text/css\" href=\"/css/style.css\" /&gt;
 &lt;script src=\"/scripts/script.js\"&gt;&lt;/script&gt;"
:html-preamble t
:html-preamble-format (("en" "&lt;nav class=\"nav\"&gt;
  &lt;a href=\"/index.html\" class=\"button\"&gt;Home&lt;/a&gt;
  &lt;a href=\"/rss.xml\" class=\"button\"&gt;RSS&lt;/a&gt;
  &lt;a href=\"/config.html\" class=\"button\"&gt;Literate Emacs Config&lt;/a&gt;
&lt;/nav&gt;
&lt;hr&gt;"))
:html-postamble t
:html-postamble-format (("en" "&lt;hr class=\"Solid\"&gt;
&lt;div class=\"info\"&gt;
  &lt;span class=\"author\"&gt;Author: %a (%e)&lt;/span&gt;
  &lt;span class=\"date\"&gt;Create Date: %d&lt;/span&gt;
  &lt;span class=\"date\"&gt;Last modified: %C&lt;/span&gt;
  &lt;span&gt;Creator: %c&lt;/span&gt;
&lt;/div&gt;"))
:with-creator nil
</code></pre>
</div>

</div>
</div>
</li>
<li><a id="org4a94332"></a>sitemap 部分<br>
<div class="outline-text-4" id="text-org4a94332">
<p>
sitemap 就是站点地图，其中列举了项目中的所有文章链接，这样通过 sitemap 就可以访问全部的文章内容。因此我们可以把 sitemap 稍作修改，用作我们博客的主页。
</p>

<p>
首先我们为博客主页固定一个创建时间：
</p>

<div class="multilang" id="orge130cf2">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>eli/org-publish-sitemap</div><pre class="src src-emacs-lisp" id="eli/org-publish-sitemap"><code>(defun eli/org-publish-sitemap (title list)
  "Generate the sitemap with title."
  (concat "#+TITLE: " title
          "\n"
          "#+DATE: 2023-10-10"
          "\n\n"
          (org-list-to-org list)))
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(defun eli/org-publish-sitemap (title list)
  "Generate the sitemap with title."
  (concat "#+TITLE: " title
          "\n"
          "#+DATE: 2023-10-10"
          "\n\n"
          (org-list-to-org list)))
</code></pre>
</div>

</div>

<p>
其次我们可以为 sitemap 中的每一个 entry 添加时间前缀：
</p>

<div class="multilang" id="org0d398f4">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>eli/sitemap-dated-entry-format</div><pre class="src src-emacs-lisp" id="eli/sitemap-dated-entry-format"><code>(defun eli/sitemap-dated-entry-format (entry _style project)
  "Sitemap PROJECT ENTRY STYLE format that includes date."
  (let* ((file (org-publish--expand-file-name entry project))
         (parsed-title (org-publish-find-property file :title project))
         (title
          (if parsed-title
              (org-no-properties
               (org-element-interpret-data parsed-title))
            (file-name-nondirectory (file-name-sans-extension file)))))
    (org-publish-cache-set-file-property file :title title)
    (if (= (length title) 0)
        (format "*%s*" entry)
      (format "{{{timestamp(%s)}}}   [[file:%s][%s]]"
              (car (org-publish-find-property file :date project))
              (concat "articles/" entry)
              title))))
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(defun eli/sitemap-dated-entry-format (entry _style project)
  "Sitemap PROJECT ENTRY STYLE format that includes date."
  (let* ((file (org-publish--expand-file-name entry project))
         (parsed-title (org-publish-find-property file :title project))
         (title
          (if parsed-title
              (org-no-properties
               (org-element-interpret-data parsed-title))
            (file-name-nondirectory (file-name-sans-extension file)))))
    (org-publish-cache-set-file-property file :title title)
    (if (= (length title) 0)
        (format "*%s*" entry)
      (format "{{{timestamp(%s)}}}   [[file:%s][%s]]"
              (car (org-publish-find-property file :date project))
              (concat "articles/" entry)
              title))))
</code></pre>
</div>

</div>

<p>
注意 <code>eli/sitemap-dated-entry-format</code> 里的 <code>{{{timestamp(%s)}}}</code> 是一个导出宏：
</p>

<div class="multilang" id="org1c1fb19">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>timestamp-macro</div><pre class="src src-emacs-lisp" id="timestamp-macro"><code>(add-to-list 'org-export-global-macros
             '("timestamp" . "@@html:&lt;span class=\"timestamp\"&gt;[$1]&lt;/span&gt;@@"))
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(add-to-list 'org-export-global-macros
             '("timestamp" . "@@html:&lt;span class=\"timestamp\"&gt;[$1]&lt;/span&gt;@@"))
</code></pre>
</div>

</div>

<p>
一般情况下 sitemap 会和同一 <code>:base-directory</code> 目录下的其他文件一起导出到
<code>:publishing-directory</code> ，但从<a href="#org2bffcbf">博客结构</a>一节可以看出，我们希望把 sitemap 导出到博客的根目录来充当主页，所以需要利用 <code>:completion-function</code> 属性来在导出完成后把
sitemap 移到根目录
</p>

<div class="multilang" id="org9a76b36">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>eli/blog-publish-completion</div><pre class="src src-emacs-lisp" id="eli/blog-publish-completion"><code>(defun eli/blog-publish-completion (project)
  (let* ((publishing-directory (plist-get project :publishing-directory))
         (sitamap (file-name-with-extension eli/blog-sitamap "html"))
         (orig-file (expand-file-name sitamap publishing-directory))
         (target-file (expand-file-name
                       sitamap
                       (file-name-directory publishing-directory))))
    (rename-file orig-file target-file t)))
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(defun eli/blog-publish-completion (project)
  (let* ((publishing-directory (plist-get project :publishing-directory))
         (sitamap (file-name-with-extension eli/blog-sitamap "html"))
         (orig-file (expand-file-name sitamap publishing-directory))
         (target-file (expand-file-name
                       sitamap
                       (file-name-directory publishing-directory))))
    (rename-file orig-file target-file t)))
</code></pre>
</div>

</div>

<p>
最后还有一点需要注意，在 ox-publish.el 的实现过程中，ox-publish 会优先使用正在访问博客文件的 buffer 来作为导出的来源，这在一般情况下没什么问题，但是如果你在导出前在 buffera 打开了 sitemap 文件，那么 ox-publish 就会在重新生成 sitemap 后继续使用 buffera 中的内容。此时的行为会受 <code>auto-revert</code> 或其他相关设置的影响，比如说此时 <code>auto-revert-timer</code> 的定时还没有到，那么 ox-publish 就会使用旧的 sitemap 内容。这不是我们想要的，所以我的方案是在导出前关闭访问 sitemap 的 buffer ，反正
sitemap 是自动生成的，我们也不需要修改。
</p>

<div class="multilang" id="org1cc624c">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>eli/kill-sitemap-buffer</div><pre class="src src-emacs-lisp" id="eli/kill-sitemap-buffer"><code>(defun eli/kill-sitemap-buffer (project)
  (let* ((sitemap-filename (plist-get project :sitemap-filename))
         (base-dir (plist-get project :base-directory))
         (sitemap-filepath (expand-file-name sitemap-filename base-dir)))
    (when-let ((sitemap-buffer (find-buffer-visiting sitemap-filepath)))
      (kill-buffer sitemap-buffer))))
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(defun eli/kill-sitemap-buffer (project)
  (let* ((sitemap-filename (plist-get project :sitemap-filename))
         (base-dir (plist-get project :base-directory))
         (sitemap-filepath (expand-file-name sitemap-filename base-dir)))
    (when-let ((sitemap-buffer (find-buffer-visiting sitemap-filepath)))
      (kill-buffer sitemap-buffer))))
</code></pre>
</div>

</div>

<p>
至此，一个基本的博客主页就完成了，下面是相应的属性：
</p>
<div class="multilang" id="orgdbb5618">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>sitemap</div><pre class="src src-emacs-lisp" id="sitemap"><code>:auto-sitemap t
:preparation-function eli/kill-sitemap-buffer
:completion-function eli/blog-publish-completion
:sitemap-filename ,eli/blog-sitamap
:sitemap-title "Eli's Blog"
:sitemap-sort-files anti-chronologically
:sitemap-function eli/org-publish-sitemap
:sitemap-format-entry eli/sitemap-dated-entry-format
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>:auto-sitemap t
:preparation-function eli/kill-sitemap-buffer
:completion-function eli/blog-publish-completion
:sitemap-filename ,eli/blog-sitamap
:sitemap-title "Eli's Blog"
:sitemap-sort-files anti-chronologically
:sitemap-function eli/org-publish-sitemap
:sitemap-format-entry eli/sitemap-dated-entry-format
</code></pre>
</div>

</div>
</div>
</li>
<li><a id="orga008640"></a>总结<br>
<div class="outline-text-4" id="text-orga008640">
<p>
现在我们已经介绍完了所有需要的属性，接下来让我们让我们把这些属性合到一起，加上名字组成一个完整的 project 。至此，一个简单的博客导出工具就完成了：
</p>
<div class="multilang" id="org239e1a4">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>&lt;&lt;blog-helper-functions&gt;&gt;

(setq org-publish-project-alist `(
                                  &lt;&lt;my-blog&gt;&gt;
                                  ))
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(org-export-define-derived-backend 'blog 'html
  :translate-alist '((src-block . eli/org-blog-src-block)))
(org-export-define-derived-backend 'blog 'html
  :translate-alist '((src-block . eli/org-blog-src-block)))
(defun eli/org-blog-src-block (src-block _contents info)
  "Transcode a SRC-BLOCK element from Org to HTML.
CONTENTS holds the contents of the item.  INFO is a plist holding
contextual information."
  (if (org-export-read-attribute :attr_html src-block :textarea)
      (org-html--textarea-block src-block)
    (let* ((lang (org-element-property :language src-block))
           (code (org-html-format-code src-block info))
           (label (let ((lbl (org-html--reference src-block info t)))
                    (if lbl (format " id=\"%s\"" lbl) "")))
           (klipsify  (and  (plist-get info :html-klipsify-src)
                            (member lang '("javascript" "js"
                                           "ruby" "scheme" "clojure" "php" "html")))))
      (if (not lang) (format "&lt;pre class=\"example\"%s&gt;\n%s&lt;/pre&gt;" label code)
        (format "&lt;div class=\"org-src-container\"&gt;\n%s%s\n&lt;/div&gt;"
                ;; Build caption.
                (let ((caption (or (org-export-get-caption src-block)
                                   (org-element-property :name src-block))))
                  (if (not caption) ""
                    (let ((listing-number
                           (format
                            "&lt;span class=\"listing-number\"&gt;%s &lt;/span&gt;"
                            "Label: ")))
                      (format "&lt;div class=\"org-src-name\"&gt;%s%s&lt;/div&gt;"
                              listing-number
                              (org-trim (org-export-data caption info))))))
                ;; Contents.
                (if klipsify
                    (format "&lt;pre&gt;&lt;code class=\"src src-%s\"%s%s&gt;%s&lt;/code&gt;&lt;/pre&gt;"
                            lang
                            label
                            (if (string= lang "html")
                                " data-editor-type=\"html\""
                              "")
                            code)
                  (format "&lt;pre class=\"src src-%s\"%s&gt;%s&lt;/pre&gt;"
                          lang label code)))))))
(defun eli/org-blog-src-block (src-block _contents info)
  "Transcode a SRC-BLOCK element from Org to HTML.
CONTENTS holds the contents of the item.  INFO is a plist holding
contextual information."
  (if (org-export-read-attribute :attr_html src-block :textarea)
      (org-html--textarea-block src-block)
    (let* ((lang (org-element-property :language src-block))
           (code (org-html-format-code src-block info))
           (label (let ((lbl (org-html--reference src-block info t)))
                    (if lbl (format " id=\"%s\"" lbl) "")))
           (klipsify  (and  (plist-get info :html-klipsify-src)
                            (member lang '("javascript" "js"
                                           "ruby" "scheme" "clojure" "php" "html")))))
      (if (not lang) (format "&lt;pre class=\"example\"%s&gt;\n%s&lt;/pre&gt;" label code)
        (format "&lt;div class=\"org-src-container\"&gt;\n%s%s\n&lt;/div&gt;"
                ;; Build caption.
                (let ((caption (or (org-export-get-caption src-block)
                                   (org-element-property :name src-block))))
                  (if (not caption) ""
                    (let ((listing-number
                           (format
                            "&lt;span class=\"listing-number\"&gt;%s &lt;/span&gt;"
                            "Label: ")))
                      (format "&lt;div class=\"org-src-name\"&gt;%s%s&lt;/div&gt;"
                              listing-number
                              (org-trim (org-export-data caption info))))))
                ;; Contents.
                (if klipsify
                    (format "&lt;pre&gt;&lt;code class=\"src src-%s\"%s%s&gt;%s&lt;/code&gt;&lt;/pre&gt;"
                            lang
                            label
                            (if (string= lang "html")
                                " data-editor-type=\"html\""
                              "")
                            code)
                  (format "&lt;pre class=\"src src-%s\"%s&gt;%s&lt;/pre&gt;"
                          lang label code)))))))
;;;###autoload
(defun eli/org-blog-publish-to-html (plist filename pub-dir)
  "Publish an org file to HTML.

FILENAME is the filename of the Org file to be published.  PLIST
is the property list for the given project.  PUB-DIR is the
publishing directory.

Return output file name."
  (org-publish-org-to 'blog filename
                      (concat (when (&gt; (length org-html-extension) 0) ".")
                              (or (plist-get plist :html-extension)
                                  org-html-extension
                                  "html"))
                      plist pub-dir))
;;;###autoload
(defun eli/org-blog-publish-to-html (plist filename pub-dir)
  "Publish an org file to HTML.

FILENAME is the filename of the Org file to be published.  PLIST
is the property list for the given project.  PUB-DIR is the
publishing directory.

Return output file name."
  (org-publish-org-to 'blog filename
                      (concat (when (&gt; (length org-html-extension) 0) ".")
                              (or (plist-get plist :html-extension)
                                  org-html-extension
                                  "html"))
                      plist pub-dir))
(setq eli/blog-base-dir "path-to/blog/"
      eli/blog-publish-dir "your-blog-site-dir"
      eli/blog-sitamap "index.org")
(setq eli/blog-base-dir "path-to/blog/"
      eli/blog-publish-dir "your-blog-site-dir"
      eli/blog-sitamap "index.org")
(defun eli/org-publish-sitemap (title list)
  "Generate the sitemap with title."
  (concat "#+TITLE: " title
          "\n"
          "#+DATE: 2023-10-10"
          "\n\n"
          (org-list-to-org list)))
(defun eli/org-publish-sitemap (title list)
  "Generate the sitemap with title."
  (concat "#+TITLE: " title
          "\n"
          "#+DATE: 2023-10-10"
          "\n\n"
          (org-list-to-org list)))
(defun eli/sitemap-dated-entry-format (entry _style project)
  "Sitemap PROJECT ENTRY STYLE format that includes date."
  (let* ((file (org-publish--expand-file-name entry project))
         (parsed-title (org-publish-find-property file :title project))
         (title
          (if parsed-title
              (org-no-properties
               (org-element-interpret-data parsed-title))
            (file-name-nondirectory (file-name-sans-extension file)))))
    (org-publish-cache-set-file-property file :title title)
    (if (= (length title) 0)
        (format "*%s*" entry)
      (format "{{{timestamp(%s)}}}   [[file:%s][%s]]"
              (car (org-publish-find-property file :date project))
              (concat "articles/" entry)
              title))))
(defun eli/sitemap-dated-entry-format (entry _style project)
  "Sitemap PROJECT ENTRY STYLE format that includes date."
  (let* ((file (org-publish--expand-file-name entry project))
         (parsed-title (org-publish-find-property file :title project))
         (title
          (if parsed-title
              (org-no-properties
               (org-element-interpret-data parsed-title))
            (file-name-nondirectory (file-name-sans-extension file)))))
    (org-publish-cache-set-file-property file :title title)
    (if (= (length title) 0)
        (format "*%s*" entry)
      (format "{{{timestamp(%s)}}}   [[file:%s][%s]]"
              (car (org-publish-find-property file :date project))
              (concat "articles/" entry)
              title))))
(add-to-list 'org-export-global-macros
             '("timestamp" . "@@html:&lt;span class=\"timestamp\"&gt;[$1]&lt;/span&gt;@@"))
(add-to-list 'org-export-global-macros
             '("timestamp" . "@@html:&lt;span class=\"timestamp\"&gt;[$1]&lt;/span&gt;@@"))
(defun eli/blog-publish-completion (project)
  (let* ((publishing-directory (plist-get project :publishing-directory))
         (sitamap (file-name-with-extension eli/blog-sitamap "html"))
         (orig-file (expand-file-name sitamap publishing-directory))
         (target-file (expand-file-name
                       sitamap
                       (file-name-directory publishing-directory))))
    (rename-file orig-file target-file t)))
(defun eli/blog-publish-completion (project)
  (let* ((publishing-directory (plist-get project :publishing-directory))
         (sitamap (file-name-with-extension eli/blog-sitamap "html"))
         (orig-file (expand-file-name sitamap publishing-directory))
         (target-file (expand-file-name
                       sitamap
                       (file-name-directory publishing-directory))))
    (rename-file orig-file target-file t)))
(defun eli/kill-sitemap-buffer (project)
  (let* ((sitemap-filename (plist-get project :sitemap-filename))
         (base-dir (plist-get project :base-directory))
         (sitemap-filepath (expand-file-name sitemap-filename base-dir)))
    (when-let ((sitemap-buffer (find-buffer-visiting sitemap-filepath)))
      (kill-buffer sitemap-buffer))))
(defun eli/kill-sitemap-buffer (project)
  (let* ((sitemap-filename (plist-get project :sitemap-filename))
         (base-dir (plist-get project :base-directory))
         (sitemap-filepath (expand-file-name sitemap-filename base-dir)))
    (when-let ((sitemap-buffer (find-buffer-visiting sitemap-filepath)))
      (kill-buffer sitemap-buffer))))

(setq org-publish-project-alist `(
                                  ("eli's blog"
                                   :base-directory ,eli/blog-base-dir
                                   :publishing-directory ,(expand-file-name "articles" eli/blog-publish-dir)
                                   :base-extension "org"
                                   :recursive nil
                                   :htmlized-source t
                                   :publishing-function eli/org-blog-publish-to-html
                                   :exclude "rss.org"

                                   :auto-sitemap t
                                   :preparation-function eli/kill-sitemap-buffer
                                   :completion-function eli/blog-publish-completion
                                   :sitemap-filename ,eli/blog-sitamap
                                   :sitemap-title "Eli's Blog"
                                   :sitemap-sort-files anti-chronologically
                                   :sitemap-function eli/org-publish-sitemap
                                   :sitemap-format-entry eli/sitemap-dated-entry-format

                                   :html-head "&lt;link rel=\"stylesheet\" type=\"text/css\" href=\"/css/style.css\" /&gt;
                                    &lt;script src=\"/scripts/script.js\"&gt;&lt;/script&gt;"
                                   :html-preamble t
                                   :html-preamble-format (("en" "&lt;nav class=\"nav\"&gt;
                                     &lt;a href=\"/index.html\" class=\"button\"&gt;Home&lt;/a&gt;
                                     &lt;a href=\"/rss.xml\" class=\"button\"&gt;RSS&lt;/a&gt;
                                     &lt;a href=\"/config.html\" class=\"button\"&gt;Literate Emacs Config&lt;/a&gt;
                                   &lt;/nav&gt;
                                   &lt;hr&gt;"))
                                   :html-postamble t
                                   :html-postamble-format (("en" "&lt;hr class=\"Solid\"&gt;
                                   &lt;div class=\"info\"&gt;
                                     &lt;span class=\"author\"&gt;Author: %a (%e)&lt;/span&gt;
                                     &lt;span class=\"date\"&gt;Create Date: %d&lt;/span&gt;
                                     &lt;span class=\"date\"&gt;Last modified: %C&lt;/span&gt;
                                     &lt;span&gt;Creator: %c&lt;/span&gt;
                                   &lt;/div&gt;"))
                                   :with-creator nil
                                   )
                                  ))
</code></pre>
</div>

</div>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-org07ca46b" class="outline-2">
<h2 id="org07ca46b"><span class="section-number-2">2.</span> RSS 生成</h2>
<div class="outline-text-2" id="text-2">
<p>
RSS 对于一个博客来说是比较重要的，可惜的是 ox-publish.el 没有原生功能支持。不过好在有 <a href="https://github.com/BenedictHW/ox-rss">GitHub - BenedictHW/ox-rss</a> 。然而 ox-rss 也有缺点，它只能用于单个文件里的
headlines 。因此我们需要曲线救国，新建一个 publish 项目，使用 sitemap 来收集 RSS
entry ，生成一个 rss.org，最后把他导出成我们需要的 rss.xml 。
</p>

<div class="multilang" id="org78e9552">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>eli/org-publish-rss-entry</div><pre class="src src-emacs-lisp" id="eli/org-publish-rss-entry"><code>(defun eli/org-publish-rss-entry (entry _style project)
  "Format ENTRY for the posts RSS feed in PROJECT."
  (let* ((file (org-publish--expand-file-name entry project))
         (preview (eli/blog-get-preview file))
         (parsed-title (org-publish-find-property file :title project))
         (title
          (if parsed-title
              (org-no-properties
               (org-element-interpret-data parsed-title))
            (file-name-nondirectory (file-name-sans-extension file))))
         (root (org-publish-property :html-link-home project))
         (link (concat
                "articles/"
                (file-name-sans-extension entry) ".html"))
         (pubdate (car (org-publish-find-property file :date project))))
    (org-publish-cache-set-file-property file :title title)
    (format "%s
:properties:
:rss_permalink: %s
:pubdate: %s
:end:\n%s\n[[%s][Read More]]"
            title
            link
            pubdate
            preview
            (concat
             root
             link))))
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(defun eli/org-publish-rss-entry (entry _style project)
  "Format ENTRY for the posts RSS feed in PROJECT."
  (let* ((file (org-publish--expand-file-name entry project))
         (preview (eli/blog-get-preview file))
         (parsed-title (org-publish-find-property file :title project))
         (title
          (if parsed-title
              (org-no-properties
               (org-element-interpret-data parsed-title))
            (file-name-nondirectory (file-name-sans-extension file))))
         (root (org-publish-property :html-link-home project))
         (link (concat
                "articles/"
                (file-name-sans-extension entry) ".html"))
         (pubdate (car (org-publish-find-property file :date project))))
    (org-publish-cache-set-file-property file :title title)
    (format "%s
:properties:
:rss_permalink: %s
:pubdate: %s
:end:\n%s\n[[%s][Read More]]"
            title
            link
            pubdate
            preview
            (concat
             root
             link))))
</code></pre>
</div>

</div>

<div class="multilang" id="orgb91c477">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>eli/org-publish-rss-sitemap</div><pre class="src src-emacs-lisp" id="eli/org-publish-rss-sitemap"><code>(defun eli/org-publish-rss-sitemap (title list)
  "Generate a sitemap of posts that is exported as a RSS feed.
TITLE is the title of the RSS feed.  LIST is an internal
representation for the files to include.  PROJECT is the current
project."
  (concat
   "#+TITLE: " title
   "\n\n"
   (org-list-to-subtree list)))
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(defun eli/org-publish-rss-sitemap (title list)
  "Generate a sitemap of posts that is exported as a RSS feed.
TITLE is the title of the RSS feed.  LIST is an internal
representation for the files to include.  PROJECT is the current
project."
  (concat
   "#+TITLE: " title
   "\n\n"
   (org-list-to-subtree list)))
</code></pre>
</div>

</div>

<div class="multilang" id="orgff7f1c4">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>eli/org-publish-rss-feed</div><pre class="src src-emacs-lisp" id="eli/org-publish-rss-feed"><code>(defun eli/org-publish-rss-feed (plist filename dir)
  "Publish PLIST to Rss when FILENAME is rss.org.
DIR is the location of the output."
  (if (equal "rss.org" (file-name-nondirectory filename))
      (org-rss-publish-to-rss plist filename dir)))
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(defun eli/org-publish-rss-feed (plist filename dir)
  "Publish PLIST to Rss when FILENAME is rss.org.
DIR is the location of the output."
  (if (equal "rss.org" (file-name-nondirectory filename))
      (org-rss-publish-to-rss plist filename dir)))
</code></pre>
</div>

</div>

<div class="multilang" id="orgb306e59">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>rss-sitemap</div><pre class="src src-emacs-lisp" id="rss-sitemap"><code>:publishing-function eli/org-publish-rss-feed
:auto-sitemap t
:sitemap-function eli/org-publish-rss-sitemap
:sitemap-title "Eli's Blog"
:sitemap-filename "rss.org"
:sitemap-sort-files anti-chronologically
:sitemap-format-entry eli/org-publish-rss-entry
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>:publishing-function eli/org-publish-rss-feed
:auto-sitemap t
:sitemap-function eli/org-publish-rss-sitemap
:sitemap-title "Eli's Blog"
:sitemap-filename "rss.org"
:sitemap-sort-files anti-chronologically
:sitemap-format-entry eli/org-publish-rss-entry
</code></pre>
</div>

</div>


<p>
在导出的时候我们只希望导出 rss.org ，所以需要设置 <code>:include</code> 属性为 <code>("rss.org")</code> ，同时我们不希望收集 RSS entry 时把 index.org 中的内容也收集进去，所以需要设置
<code>:exclude</code> 属性为 <code>"index.org"</code> 。
</p>

<p>
剩余的属性如下：
</p>
<div class="multilang" id="org76efa22">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>rss-misc</div><pre class="src src-emacs-lisp" id="rss-misc"><code>:preparation-function eli/kill-sitemap-buffer
:publishing-directory ,eli/blog-publish-dir
:base-directory ,eli/blog-base-dir
:rss-extension "xml"
:base-extension "org"
:html-link-home "https://elilif.github.io/"
:html-link-use-abs-url t
:html-link-org-files-as-html t
:include ("rss.org")
:exclude "index.org"
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>:preparation-function eli/kill-sitemap-buffer
:publishing-directory ,eli/blog-publish-dir
:base-directory ,eli/blog-base-dir
:rss-extension "xml"
:base-extension "org"
:html-link-home "https://elilif.github.io/"
:html-link-use-abs-url t
:html-link-org-files-as-html t
:include ("rss.org")
:exclude "index.org"
</code></pre>
</div>

</div>

<p>
现在整个 rss 项目就完成了。
</p>
<div class="multilang" id="orgccb25da">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>rss</div><pre class="src src-emacs-lisp" id="rss"><code>("eli's blog rss"
 &lt;&lt;rss-sitemap&gt;&gt;
 &lt;&lt;rss-misc&gt;&gt;)
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>("eli's blog rss"
 :publishing-function eli/org-publish-rss-feed
 :auto-sitemap t
 :sitemap-function eli/org-publish-rss-sitemap
 :sitemap-title "Eli's Blog"
 :sitemap-filename "rss.org"
 :sitemap-sort-files anti-chronologically
 :sitemap-format-entry eli/org-publish-rss-entry
 :preparation-function eli/kill-sitemap-buffer
 :publishing-directory ,eli/blog-publish-dir
 :base-directory ,eli/blog-base-dir
 :rss-extension "xml"
 :base-extension "org"
 :html-link-home "https://elilif.github.io/"
 :html-link-use-abs-url t
 :html-link-org-files-as-html t
 :include ("rss.org")
 :exclude "index.org")
</code></pre>
</div>

</div>

<p>
下面是完整的代码：
</p>
<div class="multilang" id="org0fc1461">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>&lt;&lt;rss-helper-functions&gt;&gt;

&lt;&lt;rss&gt;&gt;
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(defun eli/org-publish-rss-entry (entry _style project)
  "Format ENTRY for the posts RSS feed in PROJECT."
  (let* ((file (org-publish--expand-file-name entry project))
         (preview (eli/blog-get-preview file))
         (parsed-title (org-publish-find-property file :title project))
         (title
          (if parsed-title
              (org-no-properties
               (org-element-interpret-data parsed-title))
            (file-name-nondirectory (file-name-sans-extension file))))
         (root (org-publish-property :html-link-home project))
         (link (concat
                "articles/"
                (file-name-sans-extension entry) ".html"))
         (pubdate (car (org-publish-find-property file :date project))))
    (org-publish-cache-set-file-property file :title title)
    (format "%s
:properties:
:rss_permalink: %s
:pubdate: %s
:end:\n%s\n[[%s][Read More]]"
            title
            link
            pubdate
            preview
            (concat
             root
             link))))
(defun eli/org-publish-rss-entry (entry _style project)
  "Format ENTRY for the posts RSS feed in PROJECT."
  (let* ((file (org-publish--expand-file-name entry project))
         (preview (eli/blog-get-preview file))
         (parsed-title (org-publish-find-property file :title project))
         (title
          (if parsed-title
              (org-no-properties
               (org-element-interpret-data parsed-title))
            (file-name-nondirectory (file-name-sans-extension file))))
         (root (org-publish-property :html-link-home project))
         (link (concat
                "articles/"
                (file-name-sans-extension entry) ".html"))
         (pubdate (car (org-publish-find-property file :date project))))
    (org-publish-cache-set-file-property file :title title)
    (format "%s
:properties:
:rss_permalink: %s
:pubdate: %s
:end:\n%s\n[[%s][Read More]]"
            title
            link
            pubdate
            preview
            (concat
             root
             link))))
(defun eli/org-publish-rss-sitemap (title list)
  "Generate a sitemap of posts that is exported as a RSS feed.
TITLE is the title of the RSS feed.  LIST is an internal
representation for the files to include.  PROJECT is the current
project."
  (concat
   "#+TITLE: " title
   "\n\n"
   (org-list-to-subtree list)))
(defun eli/org-publish-rss-sitemap (title list)
  "Generate a sitemap of posts that is exported as a RSS feed.
TITLE is the title of the RSS feed.  LIST is an internal
representation for the files to include.  PROJECT is the current
project."
  (concat
   "#+TITLE: " title
   "\n\n"
   (org-list-to-subtree list)))
(defun eli/org-publish-rss-feed (plist filename dir)
  "Publish PLIST to Rss when FILENAME is rss.org.
DIR is the location of the output."
  (if (equal "rss.org" (file-name-nondirectory filename))
      (org-rss-publish-to-rss plist filename dir)))
(defun eli/org-publish-rss-feed (plist filename dir)
  "Publish PLIST to Rss when FILENAME is rss.org.
DIR is the location of the output."
  (if (equal "rss.org" (file-name-nondirectory filename))
      (org-rss-publish-to-rss plist filename dir)))

("eli's blog rss"
 :publishing-function eli/org-publish-rss-feed
 :auto-sitemap t
 :sitemap-function eli/org-publish-rss-sitemap
 :sitemap-title "Eli's Blog"
 :sitemap-filename "rss.org"
 :sitemap-sort-files anti-chronologically
 :sitemap-format-entry eli/org-publish-rss-entry
 :preparation-function eli/kill-sitemap-buffer
 :publishing-directory ,eli/blog-publish-dir
 :base-directory ,eli/blog-base-dir
 :rss-extension "xml"
 :base-extension "org"
 :html-link-home "https://elilif.github.io/"
 :html-link-use-abs-url t
 :html-link-org-files-as-html t
 :include ("rss.org")
 :exclude "index.org")
</code></pre>
</div>

</div>
</div>
</div>
<div id="outline-container-org0428cd8" class="outline-2">
<h2 id="org0428cd8"><span class="section-number-2">3.</span> Org 文学编程网页导出</h2>
<div class="outline-text-2" id="text-3">
<p>
我希望在导出时能够把代码块中的 noweb 展开，并且在网页中同时提供不展开和展开两种版本。这样就能在保持原汁原味的文学编程的同时又方便读者查看。下面是大致实现思路：
</p>

<p>
通过 <code>org-export-before-processing-functions</code> 在导出时复制一遍代码块，并在添上
<code>:noweb yes</code> 参数后和原代码块放到一个 special block (<code>#+begin_multilang</code> 、
<code>#+end_multilang</code>) 之间。这样在 HTML 就是一个 class 为 <code>multilang</code> 的 <code>div</code> 。然后使用
js 添加一个按钮，实现不同版本间的切换。
</p>

<div class="multilang" id="org2767a92">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>eli/org-export-src-babel-duplicate</div><pre class="src src-emacs-lisp" id="eli/org-export-src-babel-duplicate"><code>(defun eli/org-export-src-babel-duplicate (backend)
  "Duplicate every src babels in the current buffer.

add \":noweb yes\" to duplicated src babels."
  (when (eq backend 'blog)
    (save-excursion
      (goto-char (point-min))
      (while (re-search-forward org-babel-src-block-regexp nil t)
        (let ((end (copy-marker (match-end 0)))
              (string (match-string 0))
              (block (org-element-at-point)))
          (goto-char (org-element-property :begin block))
          (insert "#+begin_multilang")
          (insert "\n")
          (goto-char end)
          (insert "\n")
          (insert string)
          (save-excursion
            (goto-char (1+ end))
            (end-of-line)
            (insert " :noweb yes"))
          (insert "\n")
          (insert "#+end_multilang"))))))

(add-hook 'org-export-before-processing-functions #'eli/org-export-src-babel-duplicate)
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(defun eli/org-export-src-babel-duplicate (backend)
  "Duplicate every src babels in the current buffer.

add \":noweb yes\" to duplicated src babels."
  (when (eq backend 'blog)
    (save-excursion
      (goto-char (point-min))
      (while (re-search-forward org-babel-src-block-regexp nil t)
        (let ((end (copy-marker (match-end 0)))
              (string (match-string 0))
              (block (org-element-at-point)))
          (goto-char (org-element-property :begin block))
          (insert "#+begin_multilang")
          (insert "\n")
          (goto-char end)
          (insert "\n")
          (insert string)
          (save-excursion
            (goto-char (1+ end))
            (end-of-line)
            (insert " :noweb yes"))
          (insert "\n")
          (insert "#+end_multilang"))))))

(add-hook 'org-export-before-processing-functions #'eli/org-export-src-babel-duplicate)
</code></pre>
</div>

</div>

<p>
Emacs 配置部分的 project 如下：
</p>
<div class="multilang" id="org61c74a0">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>emacs-config</div><pre class="src src-emacs-lisp" id="emacs-config"><code>("Emacs config"
 :publishing-directory ,eli/blog-publish-dir
 :base-directory ,user-emacs-directory
 :include ("config.org")
 :publishing-function eli/org-blog-publish-to-html
 &lt;&lt;html&gt;&gt;)
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>("Emacs config"
 :publishing-directory ,eli/blog-publish-dir
 :base-directory ,user-emacs-directory
 :include ("config.org")
 :publishing-function eli/org-blog-publish-to-html
 :html-head "&lt;link rel=\"stylesheet\" type=\"text/css\" href=\"/css/style.css\" /&gt;
  &lt;script src=\"/scripts/script.js\"&gt;&lt;/script&gt;"
 :html-preamble t
 :html-preamble-format (("en" "&lt;nav class=\"nav\"&gt;
   &lt;a href=\"/index.html\" class=\"button\"&gt;Home&lt;/a&gt;
   &lt;a href=\"/rss.xml\" class=\"button\"&gt;RSS&lt;/a&gt;
   &lt;a href=\"/config.html\" class=\"button\"&gt;Literate Emacs Config&lt;/a&gt;
 &lt;/nav&gt;
 &lt;hr&gt;"))
 :html-postamble t
 :html-postamble-format (("en" "&lt;hr class=\"Solid\"&gt;
 &lt;div class=\"info\"&gt;
   &lt;span class=\"author\"&gt;Author: %a (%e)&lt;/span&gt;
   &lt;span class=\"date\"&gt;Create Date: %d&lt;/span&gt;
   &lt;span class=\"date\"&gt;Last modified: %C&lt;/span&gt;
   &lt;span&gt;Creator: %c&lt;/span&gt;
 &lt;/div&gt;"))
 :with-creator nil)
</code></pre>
</div>

</div>
</div>
</div>
<div id="outline-container-orga26fcaf" class="outline-2">
<h2 id="orga26fcaf"><span class="section-number-2">4.</span> 总结</h2>
<div class="outline-text-2" id="text-4">
<p>
以下代码完整地包括了前文提到的内容：
</p>
<div class="multilang" id="org53555b7">
<div class="org-src-container">
<div class="org-src-name"><span class="listing-number">Label:  </span>result</div><pre class="src src-emacs-lisp" id="result"><code>&lt;&lt;blog-helper-functions&gt;&gt;

&lt;&lt;rss-helper-functions&gt;&gt;

&lt;&lt;config-helper-functions&gt;&gt;

(setq org-publish-project-alist `(
                                  &lt;&lt;my-blog&gt;&gt;
                                  &lt;&lt;rss&gt;&gt;
                                  &lt;&lt;emacs-config&gt;&gt;
                                  ))
</code></pre>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code>(org-export-define-derived-backend 'blog 'html
  :translate-alist '((src-block . eli/org-blog-src-block)))
(org-export-define-derived-backend 'blog 'html
  :translate-alist '((src-block . eli/org-blog-src-block)))
(defun eli/org-blog-src-block (src-block _contents info)
  "Transcode a SRC-BLOCK element from Org to HTML.
CONTENTS holds the contents of the item.  INFO is a plist holding
contextual information."
  (if (org-export-read-attribute :attr_html src-block :textarea)
      (org-html--textarea-block src-block)
    (let* ((lang (org-element-property :language src-block))
           (code (org-html-format-code src-block info))
           (label (let ((lbl (org-html--reference src-block info t)))
                    (if lbl (format " id=\"%s\"" lbl) "")))
           (klipsify  (and  (plist-get info :html-klipsify-src)
                            (member lang '("javascript" "js"
                                           "ruby" "scheme" "clojure" "php" "html")))))
      (if (not lang) (format "&lt;pre class=\"example\"%s&gt;\n%s&lt;/pre&gt;" label code)
        (format "&lt;div class=\"org-src-container\"&gt;\n%s%s\n&lt;/div&gt;"
                ;; Build caption.
                (let ((caption (or (org-export-get-caption src-block)
                                   (org-element-property :name src-block))))
                  (if (not caption) ""
                    (let ((listing-number
                           (format
                            "&lt;span class=\"listing-number\"&gt;%s &lt;/span&gt;"
                            "Label: ")))
                      (format "&lt;div class=\"org-src-name\"&gt;%s%s&lt;/div&gt;"
                              listing-number
                              (org-trim (org-export-data caption info))))))
                ;; Contents.
                (if klipsify
                    (format "&lt;pre&gt;&lt;code class=\"src src-%s\"%s%s&gt;%s&lt;/code&gt;&lt;/pre&gt;"
                            lang
                            label
                            (if (string= lang "html")
                                " data-editor-type=\"html\""
                              "")
                            code)
                  (format "&lt;pre class=\"src src-%s\"%s&gt;%s&lt;/pre&gt;"
                          lang label code)))))))
(defun eli/org-blog-src-block (src-block _contents info)
  "Transcode a SRC-BLOCK element from Org to HTML.
CONTENTS holds the contents of the item.  INFO is a plist holding
contextual information."
  (if (org-export-read-attribute :attr_html src-block :textarea)
      (org-html--textarea-block src-block)
    (let* ((lang (org-element-property :language src-block))
           (code (org-html-format-code src-block info))
           (label (let ((lbl (org-html--reference src-block info t)))
                    (if lbl (format " id=\"%s\"" lbl) "")))
           (klipsify  (and  (plist-get info :html-klipsify-src)
                            (member lang '("javascript" "js"
                                           "ruby" "scheme" "clojure" "php" "html")))))
      (if (not lang) (format "&lt;pre class=\"example\"%s&gt;\n%s&lt;/pre&gt;" label code)
        (format "&lt;div class=\"org-src-container\"&gt;\n%s%s\n&lt;/div&gt;"
                ;; Build caption.
                (let ((caption (or (org-export-get-caption src-block)
                                   (org-element-property :name src-block))))
                  (if (not caption) ""
                    (let ((listing-number
                           (format
                            "&lt;span class=\"listing-number\"&gt;%s &lt;/span&gt;"
                            "Label: ")))
                      (format "&lt;div class=\"org-src-name\"&gt;%s%s&lt;/div&gt;"
                              listing-number
                              (org-trim (org-export-data caption info))))))
                ;; Contents.
                (if klipsify
                    (format "&lt;pre&gt;&lt;code class=\"src src-%s\"%s%s&gt;%s&lt;/code&gt;&lt;/pre&gt;"
                            lang
                            label
                            (if (string= lang "html")
                                " data-editor-type=\"html\""
                              "")
                            code)
                  (format "&lt;pre class=\"src src-%s\"%s&gt;%s&lt;/pre&gt;"
                          lang label code)))))))
;;;###autoload
(defun eli/org-blog-publish-to-html (plist filename pub-dir)
  "Publish an org file to HTML.

FILENAME is the filename of the Org file to be published.  PLIST
is the property list for the given project.  PUB-DIR is the
publishing directory.

Return output file name."
  (org-publish-org-to 'blog filename
                      (concat (when (&gt; (length org-html-extension) 0) ".")
                              (or (plist-get plist :html-extension)
                                  org-html-extension
                                  "html"))
                      plist pub-dir))
;;;###autoload
(defun eli/org-blog-publish-to-html (plist filename pub-dir)
  "Publish an org file to HTML.

FILENAME is the filename of the Org file to be published.  PLIST
is the property list for the given project.  PUB-DIR is the
publishing directory.

Return output file name."
  (org-publish-org-to 'blog filename
                      (concat (when (&gt; (length org-html-extension) 0) ".")
                              (or (plist-get plist :html-extension)
                                  org-html-extension
                                  "html"))
                      plist pub-dir))
(setq eli/blog-base-dir "path-to/blog/"
      eli/blog-publish-dir "your-blog-site-dir"
      eli/blog-sitamap "index.org")
(setq eli/blog-base-dir "path-to/blog/"
      eli/blog-publish-dir "your-blog-site-dir"
      eli/blog-sitamap "index.org")
(defun eli/org-publish-sitemap (title list)
  "Generate the sitemap with title."
  (concat "#+TITLE: " title
          "\n"
          "#+DATE: 2023-10-10"
          "\n\n"
          (org-list-to-org list)))
(defun eli/org-publish-sitemap (title list)
  "Generate the sitemap with title."
  (concat "#+TITLE: " title
          "\n"
          "#+DATE: 2023-10-10"
          "\n\n"
          (org-list-to-org list)))
(defun eli/sitemap-dated-entry-format (entry _style project)
  "Sitemap PROJECT ENTRY STYLE format that includes date."
  (let* ((file (org-publish--expand-file-name entry project))
         (parsed-title (org-publish-find-property file :title project))
         (title
          (if parsed-title
              (org-no-properties
               (org-element-interpret-data parsed-title))
            (file-name-nondirectory (file-name-sans-extension file)))))
    (org-publish-cache-set-file-property file :title title)
    (if (= (length title) 0)
        (format "*%s*" entry)
      (format "{{{timestamp(%s)}}}   [[file:%s][%s]]"
              (car (org-publish-find-property file :date project))
              (concat "articles/" entry)
              title))))
(defun eli/sitemap-dated-entry-format (entry _style project)
  "Sitemap PROJECT ENTRY STYLE format that includes date."
  (let* ((file (org-publish--expand-file-name entry project))
         (parsed-title (org-publish-find-property file :title project))
         (title
          (if parsed-title
              (org-no-properties
               (org-element-interpret-data parsed-title))
            (file-name-nondirectory (file-name-sans-extension file)))))
    (org-publish-cache-set-file-property file :title title)
    (if (= (length title) 0)
        (format "*%s*" entry)
      (format "{{{timestamp(%s)}}}   [[file:%s][%s]]"
              (car (org-publish-find-property file :date project))
              (concat "articles/" entry)
              title))))
(add-to-list 'org-export-global-macros
             '("timestamp" . "@@html:&lt;span class=\"timestamp\"&gt;[$1]&lt;/span&gt;@@"))
(add-to-list 'org-export-global-macros
             '("timestamp" . "@@html:&lt;span class=\"timestamp\"&gt;[$1]&lt;/span&gt;@@"))
(defun eli/blog-publish-completion (project)
  (let* ((publishing-directory (plist-get project :publishing-directory))
         (sitamap (file-name-with-extension eli/blog-sitamap "html"))
         (orig-file (expand-file-name sitamap publishing-directory))
         (target-file (expand-file-name
                       sitamap
                       (file-name-directory publishing-directory))))
    (rename-file orig-file target-file t)))
(defun eli/blog-publish-completion (project)
  (let* ((publishing-directory (plist-get project :publishing-directory))
         (sitamap (file-name-with-extension eli/blog-sitamap "html"))
         (orig-file (expand-file-name sitamap publishing-directory))
         (target-file (expand-file-name
                       sitamap
                       (file-name-directory publishing-directory))))
    (rename-file orig-file target-file t)))
(defun eli/kill-sitemap-buffer (project)
  (let* ((sitemap-filename (plist-get project :sitemap-filename))
         (base-dir (plist-get project :base-directory))
         (sitemap-filepath (expand-file-name sitemap-filename base-dir)))
    (when-let ((sitemap-buffer (find-buffer-visiting sitemap-filepath)))
      (kill-buffer sitemap-buffer))))
(defun eli/kill-sitemap-buffer (project)
  (let* ((sitemap-filename (plist-get project :sitemap-filename))
         (base-dir (plist-get project :base-directory))
         (sitemap-filepath (expand-file-name sitemap-filename base-dir)))
    (when-let ((sitemap-buffer (find-buffer-visiting sitemap-filepath)))
      (kill-buffer sitemap-buffer))))

(defun eli/org-publish-rss-entry (entry _style project)
  "Format ENTRY for the posts RSS feed in PROJECT."
  (let* ((file (org-publish--expand-file-name entry project))
         (preview (eli/blog-get-preview file))
         (parsed-title (org-publish-find-property file :title project))
         (title
          (if parsed-title
              (org-no-properties
               (org-element-interpret-data parsed-title))
            (file-name-nondirectory (file-name-sans-extension file))))
         (root (org-publish-property :html-link-home project))
         (link (concat
                "articles/"
                (file-name-sans-extension entry) ".html"))
         (pubdate (car (org-publish-find-property file :date project))))
    (org-publish-cache-set-file-property file :title title)
    (format "%s
:properties:
:rss_permalink: %s
:pubdate: %s
:end:\n%s\n[[%s][Read More]]"
            title
            link
            pubdate
            preview
            (concat
             root
             link))))
(defun eli/org-publish-rss-entry (entry _style project)
  "Format ENTRY for the posts RSS feed in PROJECT."
  (let* ((file (org-publish--expand-file-name entry project))
         (preview (eli/blog-get-preview file))
         (parsed-title (org-publish-find-property file :title project))
         (title
          (if parsed-title
              (org-no-properties
               (org-element-interpret-data parsed-title))
            (file-name-nondirectory (file-name-sans-extension file))))
         (root (org-publish-property :html-link-home project))
         (link (concat
                "articles/"
                (file-name-sans-extension entry) ".html"))
         (pubdate (car (org-publish-find-property file :date project))))
    (org-publish-cache-set-file-property file :title title)
    (format "%s
:properties:
:rss_permalink: %s
:pubdate: %s
:end:\n%s\n[[%s][Read More]]"
            title
            link
            pubdate
            preview
            (concat
             root
             link))))
(defun eli/org-publish-rss-sitemap (title list)
  "Generate a sitemap of posts that is exported as a RSS feed.
TITLE is the title of the RSS feed.  LIST is an internal
representation for the files to include.  PROJECT is the current
project."
  (concat
   "#+TITLE: " title
   "\n\n"
   (org-list-to-subtree list)))
(defun eli/org-publish-rss-sitemap (title list)
  "Generate a sitemap of posts that is exported as a RSS feed.
TITLE is the title of the RSS feed.  LIST is an internal
representation for the files to include.  PROJECT is the current
project."
  (concat
   "#+TITLE: " title
   "\n\n"
   (org-list-to-subtree list)))
(defun eli/org-publish-rss-feed (plist filename dir)
  "Publish PLIST to Rss when FILENAME is rss.org.
DIR is the location of the output."
  (if (equal "rss.org" (file-name-nondirectory filename))
      (org-rss-publish-to-rss plist filename dir)))
(defun eli/org-publish-rss-feed (plist filename dir)
  "Publish PLIST to Rss when FILENAME is rss.org.
DIR is the location of the output."
  (if (equal "rss.org" (file-name-nondirectory filename))
      (org-rss-publish-to-rss plist filename dir)))

(defun eli/org-export-src-babel-duplicate (backend)
  "Duplicate every src babels in the current buffer.

add \":noweb yes\" to duplicated src babels."
  (when (eq backend 'blog)
    (save-excursion
      (goto-char (point-min))
      (while (re-search-forward org-babel-src-block-regexp nil t)
        (let ((end (copy-marker (match-end 0)))
              (string (match-string 0))
              (block (org-element-at-point)))
          (goto-char (org-element-property :begin block))
          (insert "#+begin_multilang")
          (insert "\n")
          (goto-char end)
          (insert "\n")
          (insert string)
          (save-excursion
            (goto-char (1+ end))
            (end-of-line)
            (insert " :noweb yes"))
          (insert "\n")
          (insert "#+end_multilang"))))))

(add-hook 'org-export-before-processing-functions #'eli/org-export-src-babel-duplicate)
(defun eli/org-export-src-babel-duplicate (backend)
  "Duplicate every src babels in the current buffer.

add \":noweb yes\" to duplicated src babels."
  (when (eq backend 'blog)
    (save-excursion
      (goto-char (point-min))
      (while (re-search-forward org-babel-src-block-regexp nil t)
        (let ((end (copy-marker (match-end 0)))
              (string (match-string 0))
              (block (org-element-at-point)))
          (goto-char (org-element-property :begin block))
          (insert "#+begin_multilang")
          (insert "\n")
          (goto-char end)
          (insert "\n")
          (insert string)
          (save-excursion
            (goto-char (1+ end))
            (end-of-line)
            (insert " :noweb yes"))
          (insert "\n")
          (insert "#+end_multilang"))))))

(add-hook 'org-export-before-processing-functions #'eli/org-export-src-babel-duplicate)

(setq org-publish-project-alist `(
                                  ("eli's blog"
                                   :base-directory ,eli/blog-base-dir
                                   :publishing-directory ,(expand-file-name "articles" eli/blog-publish-dir)
                                   :base-extension "org"
                                   :recursive nil
                                   :htmlized-source t
                                   :publishing-function eli/org-blog-publish-to-html
                                   :exclude "rss.org"

                                   :auto-sitemap t
                                   :preparation-function eli/kill-sitemap-buffer
                                   :completion-function eli/blog-publish-completion
                                   :sitemap-filename ,eli/blog-sitamap
                                   :sitemap-title "Eli's Blog"
                                   :sitemap-sort-files anti-chronologically
                                   :sitemap-function eli/org-publish-sitemap
                                   :sitemap-format-entry eli/sitemap-dated-entry-format

                                   :html-head "&lt;link rel=\"stylesheet\" type=\"text/css\" href=\"/css/style.css\" /&gt;
                                    &lt;script src=\"/scripts/script.js\"&gt;&lt;/script&gt;"
                                   :html-preamble t
                                   :html-preamble-format (("en" "&lt;nav class=\"nav\"&gt;
                                     &lt;a href=\"/index.html\" class=\"button\"&gt;Home&lt;/a&gt;
                                     &lt;a href=\"/rss.xml\" class=\"button\"&gt;RSS&lt;/a&gt;
                                     &lt;a href=\"/config.html\" class=\"button\"&gt;Literate Emacs Config&lt;/a&gt;
                                   &lt;/nav&gt;
                                   &lt;hr&gt;"))
                                   :html-postamble t
                                   :html-postamble-format (("en" "&lt;hr class=\"Solid\"&gt;
                                   &lt;div class=\"info\"&gt;
                                     &lt;span class=\"author\"&gt;Author: %a (%e)&lt;/span&gt;
                                     &lt;span class=\"date\"&gt;Create Date: %d&lt;/span&gt;
                                     &lt;span class=\"date\"&gt;Last modified: %C&lt;/span&gt;
                                     &lt;span&gt;Creator: %c&lt;/span&gt;
                                   &lt;/div&gt;"))
                                   :with-creator nil
                                   )
                                  ("eli's blog rss"
                                   :publishing-function eli/org-publish-rss-feed
                                   :auto-sitemap t
                                   :sitemap-function eli/org-publish-rss-sitemap
                                   :sitemap-title "Eli's Blog"
                                   :sitemap-filename "rss.org"
                                   :sitemap-sort-files anti-chronologically
                                   :sitemap-format-entry eli/org-publish-rss-entry
                                   :preparation-function eli/kill-sitemap-buffer
                                   :publishing-directory ,eli/blog-publish-dir
                                   :base-directory ,eli/blog-base-dir
                                   :rss-extension "xml"
                                   :base-extension "org"
                                   :html-link-home "https://elilif.github.io/"
                                   :html-link-use-abs-url t
                                   :html-link-org-files-as-html t
                                   :include ("rss.org")
                                   :exclude "index.org")
                                  ("Emacs config"
                                   :publishing-directory ,eli/blog-publish-dir
                                   :base-directory ,user-emacs-directory
                                   :include ("config.org")
                                   :publishing-function eli/org-blog-publish-to-html
                                   :html-head "&lt;link rel=\"stylesheet\" type=\"text/css\" href=\"/css/style.css\" /&gt;
                                    &lt;script src=\"/scripts/script.js\"&gt;&lt;/script&gt;"
                                   :html-preamble t
                                   :html-preamble-format (("en" "&lt;nav class=\"nav\"&gt;
                                     &lt;a href=\"/index.html\" class=\"button\"&gt;Home&lt;/a&gt;
                                     &lt;a href=\"/rss.xml\" class=\"button\"&gt;RSS&lt;/a&gt;
                                     &lt;a href=\"/config.html\" class=\"button\"&gt;Literate Emacs Config&lt;/a&gt;
                                   &lt;/nav&gt;
                                   &lt;hr&gt;"))
                                   :html-postamble t
                                   :html-postamble-format (("en" "&lt;hr class=\"Solid\"&gt;
                                   &lt;div class=\"info\"&gt;
                                     &lt;span class=\"author\"&gt;Author: %a (%e)&lt;/span&gt;
                                     &lt;span class=\"date\"&gt;Create Date: %d&lt;/span&gt;
                                     &lt;span class=\"date\"&gt;Last modified: %C&lt;/span&gt;
                                     &lt;span&gt;Creator: %c&lt;/span&gt;
                                   &lt;/div&gt;"))
                                   :with-creator nil)
                                  ))
</code></pre>
</div>

</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<hr class="Solid">
<div class="info">
  <span class="author">Author: Eli Qian (<a href="mailto:eli.q.qian@gmail.com">eli.q.qian@gmail.com</a>)</span>
  <span class="date">Create Date: 2024-02-21</span>
  <span class="date">Last modified: 2024-02-22 Thu 13:29</span>
  <span>Creator: <a href="https://www.gnu.org/software/emacs/">Emacs</a> 29.2 (<a href="https://orgmode.org">Org</a> mode 9.6.15)</span>
</div>
</div>
<script>window.klipse_settings = {selector_eval_html: '.src-html',
                             selector_eval_js: '.src-js',
                             selector_eval_python_client: '.src-python',
                             selector_eval_scheme: '.src-scheme',
                             selector: '.src-clojure',
                             selector_eval_ruby: '.src-ruby'};</script><script src="https://storage.googleapis.com/app.klipse.tech/plugin_prod/js/klipse_plugin.min.js"></script><link rel="stylesheet" type="text/css" href="https://storage.googleapis.com/app.klipse.tech/css/codemirror.css"/></body>
</html>
